{% extends 'base.html' %}

{% block head %}
<title>Matthew's Project</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.18/index.global.min.js"></script>
<script>
    // TODO: limit title size to 255 bytes
    // TODO: make sure end time comes after begin time
    var alert_message = '{{ alert_message }}';

    var current_icon = '{{ current_icon }}';
    var past_week_icon = {{ past_week_icon | safe }};
    var next_three_days_icon = {{ next_three_days_icon | safe }};

    var events = {{ events | safe }};

    events.forEach(e => {
        delete e.account_id;
        e.id = e.id.toString();
        e.start = e.start_time;
        delete e.start_time;
        if (e.end_time.length != 0) {
            e.end = e.end_time;
        }
        delete e.end_time;

    });

    var bgImageMap = {};

    const today = new Date();
    bgImageMap[today.toISOString().slice(0, 10)] = 'url("http:' + current_icon + '")';
    for (var i = 0; i < 7; i++) {
        today.setDate(today.getDate() - 1);
        bgImageMap[today.toISOString().slice(0, 10)] = 'url("http:' + past_week_icon[i] + '")';
    }
    today.setDate(today.getDate() + 7);
    for (var i = 0; i < 3; i++) {
        today.setDate(today.getDate() + 1);
        bgImageMap[today.toISOString().slice(0, 10)] = 'url("http:' + next_three_days_icon[i] + '")';
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (alert_message.length != 0) {
            alert(alert_message);
        }

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            themeSystem: 'bootstrap5',
            initialView: 'dayGridMonth',
            bootstrapFontAwesome: false,
            customButtons: {
                customPrev: {
                    text: 'previous',
                    click: function() {
                        calendar.removeAllEvents();
                        calendar.prev();
                    },
                    icon: 'chevron-left'
                },
                customNext: {
                    text: 'next',
                    click: function() {
                        calendar.removeAllEvents();
                        calendar.next();
                    },
                    icon: 'chevron-right'
                },
                addEvent: {
                    text: 'add event',
                    click: function() {
                        document.getElementById("addEventForm").style.display = "block";
                    },
                    icon: 'plus-lg'
                }
            },
            headerToolbar: {
                left: 'customPrev,customNext today addEvent',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: events,
            eventClick: function(info) {
                alert(info.event.title);

                var description = '';
                for (let e in events) {
                    if (e.id == info.event.id) {
                        description = e.description;
                        break;
                    }
                }

                if (description.length != 0) {
                    alert(description);
                }

                if (confirm('Would you like to delete this event?')) {
                    fetch(
                        `{{ url_for("removeEvent") }}`,
                        {
                            method: 'POST',
                            body: new URLSearchParams({ id: info.event.id })
                        }
                    )
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`Response status: ${response.status}`);
                        }

                        return response.text();
                    })
                    .then((responseText) => {
                        if (responseText.length != 0) {
                            throw new Error(responseText);
                        }
                        location.reload();
                    })
                    .catch((error) => {
                        alert(error);
                    });    
                }
            },
            dayCellDidMount: function(info) {
                const dateStr = info.date.getFullYear() + '-'
                    + String(info.date.getMonth() + 1).padStart(2, '0') + '-'
                    + String(info.date.getDate()).padStart(2, '0');

                if (bgImageMap[dateStr]) {
                    info.el.style.backgroundImage = bgImageMap[dateStr];
                    info.el.classList.add('bg-date');
                }
            }
        });
        calendar.render();
    });
</script>
{% endblock %}

{% block body %}
<div id="welcome">Welcome {{ username }}! <a href="{{ url_for('logout') }}">Logout</a></div>
<div id="calendar"></div>
<div class="form-popup" id="addEventForm">
    <form action="{{ url_for('addEvent') }}" method="post" class="form-container">
        <h1>New Event</h1>

        <label for="title"><b>Title</b></label>
        <input type="text" placeholder="Enter Title" name="title" required>

        <label for="description"><b>Description</b></label>
        <textarea name="description" rows="4" cols="50"></textarea>

        <label for="startTime"><b>Start Time</b></label>
        <input type="datetime-local" name="startTime" required>
        <br>
        <label for="endTime"><b>End Time</b></label>
        <input type="datetime-local" name="endTime">

        <button type="submit">Add Event</button>
        <button type="button"
            onclick="document.getElementById('addEventForm').style.display = 'none'">Close</button>
    </form>
</div>
<div id="copyright">
    Powered by <a href="https://www.weatherapi.com/" title="Free Weather API">WeatherAPI.com</a>
</div>
{% endblock %}